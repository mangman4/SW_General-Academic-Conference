<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>역세권 인구 분석 대시보드 V7 (Perfect Fix)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .upload-active { border-color: #6366f1; background-color: #eef2ff; }
        
        /* 멀티 셀렉트 드롭다운 스타일 */
        .dropdown-check-list { display: inline-block; position: relative; width: 220px; }
        .dropdown-check-list .anchor { position: relative; cursor: pointer; display: block; padding: 8px 10px; border: 1px solid #ccc; border-radius: 5px; background: #f9fafb; font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dropdown-check-list .anchor:after { position: absolute; content: ""; border-left: 2px solid black; border-top: 2px solid black; padding: 3px; right: 10px; top: 35%; transform: rotate(-135deg); }
        .dropdown-check-list ul.items { padding: 8px; display: none; margin: 0; border: 1px solid #ccc; border-top: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; z-index: 100; max-height: 300px; overflow-y: auto; border-radius: 0 0 5px 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .dropdown-check-list.visible .anchor { color: #4f46e5; border-color: #4f46e5; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .dropdown-check-list.visible .items { display: block; border-color: #4f46e5; }
        .dropdown-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid #f1f5f9; }
        .dropdown-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col">

    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-3 text-slate-800">
                <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <span>역세권 인구 분석 <span class="text-indigo-600">V7 (Fix)</span></span>
            </h1>
            <button onclick="location.reload()" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-100 rounded-lg transition font-medium">
                <i class="fa-solid fa-rotate-right mr-1"></i> 초기화
            </button>
        </div>
    </header>

    <main class="flex-1 max-w-7xl mx-auto px-6 py-8 w-full space-y-8">
        
        <div id="upload-section" class="animate-fade-in-up">
            <div class="card p-12 text-center border-2 border-dashed border-slate-300 hover:border-indigo-500 transition-all duration-300 cursor-pointer group relative bg-slate-50" id="drop-area">
                <input type="file" id="file-input" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="space-y-4 pointer-events-none">
                    <div class="w-24 h-24 bg-white rounded-full shadow-sm flex items-center justify-center mx-auto group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-file-csv text-4xl text-indigo-500"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-700">데이터 파일(CSV) 업로드</h3>
                        <p class="text-slate-500 mt-2">분석할 파일을 이곳에 드래그하거나 클릭하세요.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-area" class="hidden space-y-8">
            
            <div class="card p-5 sticky top-20 z-40 bg-white/95 backdrop-blur border-t-4 border-t-indigo-500 shadow-md flex flex-wrap gap-6 items-center">
                <div class="flex items-center gap-2 text-indigo-700 font-bold px-2">
                    <i class="fa-solid fa-filter"></i>
                    <span>분석 필터</span>
                </div>
                <div class="h-8 w-px bg-slate-300"></div>
                
                <div class="flex flex-col justify-center relative">
                    <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Stations (다중)</label>
                    <div id="station-list" class="dropdown-check-list" tabindex="100">
                        <span class="anchor">역 선택...</span>
                        <ul class="items custom-scroll" id="station-items"></ul>
                    </div>
                </div>
                
                <div class="flex flex-col justify-center">
                    <label class="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-1">Distance</label>
                    <select id="global-distance" class="bg-slate-50 border border-slate-300 text-sm rounded px-2 py-2 focus:border-indigo-500 outline-none w-48 font-semibold"></select>
                </div>

                <div class="ml-auto">
                     <button onclick="updateAll()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold shadow transition">
                        <i class="fa-solid fa-check mr-1"></i> 분석 적용
                    </button>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <span class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center text-sm font-bold">01</span>
                            연도별 인구 구조 (비중 정밀 계산)
                        </h3>
                        <p class="text-sm text-slate-500 mt-1">4대 연령 그룹의 합계를 기준으로 정확한 비중(%)을 계산합니다.</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-4 bg-slate-50 p-2 rounded-lg border border-slate-200">
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-600 transition">
                            <input type="checkbox" id="chart1-show-line" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" checked>
                            <span class="text-sm font-medium text-slate-600">총인구(선)</span>
                        </label>
                        <div class="h-4 w-px bg-slate-300"></div>
                        <label class="flex items-center gap-2 cursor-pointer hover:text-indigo-600 transition">
                            <input type="checkbox" id="chart1-show-label" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" checked>
                            <span class="text-sm font-medium text-slate-600">비중(%) 보기</span>
                        </label>
                    </div>
                </div>
                <div id="chart1" class="w-full h-[500px]"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="card p-6 h-full bg-white border-l-4 border-yellow-400 flex flex-col justify-center">
                        <h3 class="text-lg font-bold mb-3 text-slate-800 flex items-center gap-2">
                            <span class="w-8 h-8 bg-yellow-100 text-yellow-600 rounded-lg flex items-center justify-center text-sm font-bold">02</span>
                            연령대별 상세 분포
                        </h3>
                        <div class="grid grid-cols-2 gap-2 mb-6">
                            <div class="flex items-center gap-2 text-xs font-medium text-slate-600 bg-slate-50 p-2 rounded"><span class="w-3 h-3 rounded-full bg-red-400"></span> 0~19세</div>
                            <div class="flex items-center gap-2 text-xs font-medium text-slate-600 bg-slate-50 p-2 rounded"><span class="w-3 h-3 rounded-full bg-yellow-400"></span> 20~39세</div>
                            <div class="flex items-center gap-2 text-xs font-medium text-slate-600 bg-slate-50 p-2 rounded"><span class="w-3 h-3 rounded-full bg-green-400"></span> 40~59세</div>
                            <div class="flex items-center gap-2 text-xs font-medium text-slate-600 bg-slate-50 p-2 rounded"><span class="w-3 h-3 rounded-full bg-blue-500"></span> 60세~</div>
                        </div>
                        <label class="text-xs font-bold text-slate-500 mb-1 block">분기 선택</label>
                        <select id="chart2-quarter" class="w-full bg-white border border-slate-300 text-slate-700 text-sm rounded px-3 py-2 outline-none focus:border-yellow-500"></select>
                    </div>
                </div>
                <div class="lg:col-span-2 card p-6">
                    <div id="chart2" class="w-full h-[400px]"></div>
                </div>
            </div>

            <div class="card p-6 bg-slate-50 border-indigo-200">
                <div class="mb-6 border-b border-slate-200 pb-4">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center text-sm font-bold">03</span>
                        개통 전후 심층 분석
                    </h3>
                    <p class="text-sm text-slate-500 mt-1">개통 시점을 0으로 정렬하여 분석합니다.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-4 rounded border shadow-sm h-[450px] flex flex-col">
                         <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold text-slate-700">A. 시계열 추이</h4>
                            <label class="text-xs flex items-center gap-1"><input type="checkbox" id="chart3-aggregate" class="rounded text-emerald-600" checked> 합계 보기</label>
                        </div>
                        <div id="chart3-total" class="flex-1 w-full"></div>
                    </div>
                    <div class="bg-white p-4 rounded border shadow-sm h-[450px] flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-bold text-slate-700">B. 개통 시점 기준 (비중 표시)</h4>
                            <div class="flex bg-slate-100 rounded p-1">
                                <button onclick="setRelMode('line')" id="btn-rel-line" class="px-3 py-1 text-xs font-bold rounded bg-white shadow text-indigo-600">성장률(Index)</button>
                                <button onclick="setRelMode('bar')" id="btn-rel-bar" class="px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white/50">구조변화(Bar)</button>
                            </div>
                        </div>
                        <div id="chart3-relative" class="flex-1 w-full"></div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded border shadow-sm">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <div>
                            <h4 class="text-base font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-arrow-right-arrow-left text-blue-500"></i>
                                C. 개통 전후 증감 (명 / %)
                            </h4>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded border">
                             <select id="chart4-window" class="text-xs bg-white border border-slate-300 rounded px-2 py-1 font-bold text-slate-600">
                                <option value="6m">±6개월</option>
                                <option value="1y" selected>±1년</option>
                                <option value="2y">±2년</option>
                                <option value="3y">±3년</option>
                            </select>
                            <div class="w-px h-4 bg-slate-300"></div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="chart4-mode" value="val" class="text-blue-600" checked><span class="text-xs font-medium">증감수(명)</span></label>
                                <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="chart4-mode" value="pct" class="text-blue-600"><span class="text-xs font-medium">증감률(%)</span></label>
                            </div>
                        </div>
                    </div>
                    <div id="chart4" class="w-full h-[350px]"></div>
                </div>
            </div>
        </div>
        <footer class="mt-12 py-6 text-center text-slate-400 text-sm border-t bg-slate-50">Population Analysis Dashboard V7 &copy; 2025</footer>
    </main>

    <script>
        // ============================================================================
        // 1. CONFIG & HELPERS
        // ============================================================================
        let rawData = [];
        let relMode = 'line';

        const stationOpenYears = {
            '강일역': 2021, '미사역': 2020, '하남풍산역': 2020, '하남시청역': 2021, 
            '하남검단산역': 2021, '상일동역': 1995, '고덕역': 1995, '암사역': 1999,
            '천호역': 1999, '강동역': 1999, '길동역': 1999, '굽은다리역': 1999, '명일역': 1999
        };

        function getAgeGroup(item) {
            const num = parseInt(item.match(/\d+/)?.[0] || 0);
            if (num < 20) return { name: '0~19세', color: '#f87171', order: 1 };
            if (num < 40) return { name: '20~39세', color: '#facc15', order: 2 };
            if (num < 60) return { name: '40~59세', color: '#4ade80', order: 3 };
            return { name: '60세 이상', color: '#3b82f6', order: 4 };
        }

        function getAgeSortOrder(item) {
            const match = item.match(/\d+/);
            return match ? parseInt(match[0]) : 999;
        }

        // ============================================================================
        // 2. UI Handlers
        // ============================================================================
        const checkList = document.getElementById('station-list');
        checkList.getElementsByClassName('anchor')[0].onclick = function(evt) {
            if (checkList.classList.contains('visible')) checkList.classList.remove('visible');
            else checkList.classList.add('visible');
        }
        document.addEventListener('click', function(e) {
            if (!checkList.contains(e.target)) checkList.classList.remove('visible');
        });

        function getSelectedStations() {
            const checkboxes = document.querySelectorAll('.station-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function setRelMode(mode) {
            relMode = mode;
            document.getElementById('btn-rel-line').className = mode==='line' ? 'px-3 py-1 text-xs font-bold rounded bg-white shadow text-indigo-600' : 'px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white/50';
            document.getElementById('btn-rel-bar').className = mode==='bar' ? 'px-3 py-1 text-xs font-bold rounded bg-white shadow text-indigo-600' : 'px-3 py-1 text-xs font-bold rounded text-slate-500 hover:bg-white/50';
            updateChart3();
        }

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('upload-active'); });
        dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.classList.remove('upload-active'); });
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => processCSV(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }

        function processCSV(csvText) {
            const lines = csvText.split(/\r?\n/);
            if (lines.length < 2) { alert("데이터 오류"); return; }
            const headers = lines[0].split(',').map(h => h.trim());
            const nameIdx = headers.findIndex(h => h.includes('name') || h.includes('역명'));
            const distIdx = headers.findIndex(h => h.includes('distance'));
            const itemIdx = headers.findIndex(h => h.includes('측정항목'));
            const qIdx = headers.findIndex(h => h.includes('분기'));
            const popIdx = headers.findIndex(h => h.includes('인구수'));

            if (nameIdx === -1 || popIdx === -1) return;

            rawData = [];
            for (let i = 1; i < lines.length; i++) {
                const row = parseCSVRow(lines[i]);
                if (row.length < headers.length) continue;
                const popVal = parseFloat(row[popIdx]);
                if (isNaN(popVal)) continue;
                rawData.push({
                    name: row[nameIdx], distance: row[distIdx], item: row[itemIdx],
                    quarter: row[qIdx], year: parseInt(row[qIdx].substring(0, 4)), population: popVal
                });
            }
            initDashboard();
        }

        function parseCSVRow(text) {
            let res = [], cur = '', inQ = false;
            for (let c of text) {
                if (c === '"') inQ = !inQ; else if (c === ',' && !inQ) { res.push(cur); cur = ''; } else cur += c;
            }
            res.push(cur);
            return res;
        }

        // ============================================================================
        // 3. CHART LOGIC
        // ============================================================================
        function initDashboard() {
            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('dashboard-area').classList.remove('hidden');
            
            const stations = [...new Set(rawData.map(d => d.name))].sort();
            const distances = [...new Set(rawData.map(d => d.distance))].sort();
            const quarters = [...new Set(rawData.map(d => d.quarter))].sort();

            const listContainer = document.getElementById('station-items');
            listContainer.innerHTML = '';
            stations.forEach((st, idx) => {
                const li = document.createElement('li');
                li.className = 'dropdown-item px-3';
                li.innerHTML = `<input type="checkbox" value="${st}" class="station-checkbox w-4 h-4 text-indigo-600 rounded" ${idx===0?'checked':''}><span class="text-sm ml-2">${st}</span>`;
                listContainer.appendChild(li);
            });

            const distSel = document.getElementById('global-distance');
            distSel.innerHTML = '<option value="all">전체 (거리 합산)</option>';
            distances.forEach(d => { distSel.innerHTML += `<option value="${d}">${d}</option>`; });
            
            const qSel = document.getElementById('chart2-quarter');
            qSel.innerHTML = '';
            quarters.forEach(q => { qSel.innerHTML += `<option value="${q}">${q}</option>`; });
            qSel.value = quarters[quarters.length-1];

            document.getElementById('chart1-show-line').addEventListener('change', updateChart1);
            document.getElementById('chart1-show-label').addEventListener('change', updateChart1);
            document.getElementById('chart2-quarter').addEventListener('change', updateChart2);
            document.getElementById('chart3-aggregate').addEventListener('change', updateChart3);
            document.getElementById('chart4-window').addEventListener('change', updateChart4);
            document.getElementsByName('chart4-mode').forEach(r => r.addEventListener('change', updateChart4));

            updateAll();
        }

        function updateAll() { updateChart1(); updateChart2(); updateChart3(); updateChart4(); }

        // -----------------------------------------------------------------
        // Chart 1: 비중(%) 정밀 계산
        // -----------------------------------------------------------------
        function updateChart1() {
            const selectedStations = getSelectedStations();
            const dist = document.getElementById('global-distance').value;
            const showLine = document.getElementById('chart1-show-line').checked;
            const showLabel = document.getElementById('chart1-show-label').checked;
            if (selectedStations.length === 0) return;

            // 1. Filter Data
            let filtered = rawData.filter(d => selectedStations.includes(d.name) && (d.item.includes('세') || d.item.includes('0~')));
            if (dist !== 'all') filtered = filtered.filter(d => d.distance === dist);
            const years = [...new Set(filtered.map(d => d.year))].sort();

            // 2. Aggregate by Year & Group (Average of Quarters)
            // Logic: For each year, sum data by group.
            // To handle 'average of quarters', we group by [Station, Year, Group]. Average quarters. Then Sum Stations.
            const yearGroupData = {}; // { year: { 1: val, 2: val, 3: val, 4: val } }
            
            years.forEach(y => {
                yearGroupData[y] = {1:0, 2:0, 3:0, 4:0};
                // 해당 연도의 데이터
                const yData = filtered.filter(d => d.year === y);
                
                selectedStations.forEach(st => {
                    // 역별, 그룹별로 분기 평균 계산
                    [1, 2, 3, 4].forEach(order => {
                        // 해당 역, 해당 그룹의 rows
                        const rows = yData.filter(d => d.name === st && getAgeGroup(d.item).order === order);
                        if (rows.length > 0) {
                            // 거리 합산(all)일 경우 rows가 분기당 여러개일 수 있음 -> 분기별로 먼저 합산 후 평균
                            const qs = [...new Set(rows.map(r=>r.quarter))];
                            let sumAvg = 0;
                            qs.forEach(q => {
                                const qRows = rows.filter(r => r.quarter === q);
                                sumAvg += qRows.reduce((a,b)=>a+b.population,0);
                            });
                            yearGroupData[y][order] += (sumAvg / qs.length);
                        }
                    });
                });
            });

            // 3. Build Traces with Exact Percentages
            const traces = [];
            [1, 2, 3, 4].forEach(order => {
                const gInfo = [null, getAgeGroup('0세'), getAgeGroup('20세'), getAgeGroup('40세'), getAgeGroup('60세')][order];
                const yVals = [];
                const tVals = [];

                years.forEach(y => {
                    const val = yearGroupData[y][order];
                    yVals.push(val);
                    
                    // Denominator = Sum of the 4 displayed values
                    const total = yearGroupData[y][1] + yearGroupData[y][2] + yearGroupData[y][3] + yearGroupData[y][4];
                    
                    if (showLabel && total > 0) {
                        tVals.push((val / total * 100).toFixed(1) + '%');
                    } else {
                        tVals.push('');
                    }
                });

                traces.push({
                    x: years, y: yVals, name: gInfo.name, type: 'bar',
                    marker: { color: gInfo.color },
                    text: tVals, textposition: 'inside', textfont: { color: 'black', size: 11 }
                });
            });

            if (showLine) {
                // 총합 라인 (위에서 계산한 4개 합산 사용 -> 정합성 일치)
                const lineVals = years.map(y => yearGroupData[y][1] + yearGroupData[y][2] + yearGroupData[y][3] + yearGroupData[y][4]);
                traces.push({
                    x: years, y: lineVals, name: '총 인구(합계)',
                    type: 'scatter', mode: 'lines+markers',
                    line: { color: '#1e293b', width: 3, dash: 'dot' }, yaxis: 'y2'
                });
            }

            Plotly.newPlot('chart1', traces, {
                barmode: 'stack', paper_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { title: '연도', tickmode: 'linear', dtick: 1 },
                yaxis: { title: '인구수 (연평균)' }, yaxis2: { title: '총 인구', overlaying: 'y', side: 'right', showgrid: false },
                legend: { orientation: 'h', y: -0.15 }, margin: { t: 20, r: 50, l: 50, b: 50 }
            }, {responsive: true});
        }

        // -----------------------------------------------------------------
        // Chart 2: 정렬 유지
        // -----------------------------------------------------------------
        function updateChart2() {
            const selectedStations = getSelectedStations();
            if (selectedStations.length === 0) return;
            const dist = document.getElementById('global-distance').value;
            const q = document.getElementById('chart2-quarter').value;
            
            let filtered = rawData.filter(d => selectedStations.includes(d.name) && d.quarter === q && (d.item.includes('세')||d.item.includes('0~')));
            if (dist !== 'all') filtered = filtered.filter(d => d.distance === dist);

            const aggMap = {};
            filtered.forEach(d => aggMap[d.item] = (aggMap[d.item] || 0) + d.population);
            const items = Object.keys(aggMap).sort((a,b) => getAgeSortOrder(a) - getAgeSortOrder(b));

            Plotly.newPlot('chart2', [{
                x: items, y: items.map(i => aggMap[i]), type: 'bar',
                marker: { color: items.map(i => getAgeGroup(i).color) }
            }], { margin:{t:20,b:80}, xaxis:{tickangle:-45}, yaxis: { title: '인구수' } }, {responsive:true});
        }

        // -----------------------------------------------------------------
        // Chart 3: 비중 추가 (Bar Mode)
        // -----------------------------------------------------------------
        function updateChart3() {
            const selectedStations = getSelectedStations();
            if (selectedStations.length === 0) return;
            const dist = document.getElementById('global-distance').value;
            const isAgg = document.getElementById('chart3-aggregate').checked;

            // A. Time Series
            let baseData = rawData.filter(d => selectedStations.includes(d.name) && d.item==='계_총인구수');
            if(dist !== 'all') baseData = baseData.filter(d => d.distance === dist);
            const allQs = [...new Set(rawData.map(d=>d.quarter))].sort();
            
            const timeTraces = [];
            if (isAgg) {
                const yArr = allQs.map(q => {
                    const rows = baseData.filter(d => d.quarter === q);
                    return rows.reduce((a,b)=>a+b.population,0) || null;
                });
                timeTraces.push({ x: allQs, y: yArr, mode: 'lines+markers', name: '합계', line: {color:'#059669', width:3} });
            } else {
                selectedStations.forEach(st => {
                    const stData = baseData.filter(d => d.name === st);
                    const stQs = [...new Set(stData.map(d=>d.quarter))].sort();
                    const stY = stQs.map(q => stData.filter(d=>d.quarter===q).reduce((a,b)=>a+b.population,0)); // distance all 합산
                    timeTraces.push({ x: stQs, y: stY, mode:'lines', name:st });
                });
            }
            Plotly.newPlot('chart3-total', timeTraces, { margin: {t:20, b:40, l:40, r:20}, xaxis: { tickangle: -45 } }, {responsive:true});

            // B. Relative
            const relTraces = [];
            const xRange = [-8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8];

            if (relMode === 'line') {
                // Index Line (Existing Logic)
                const idxSums={}; const idxCnts={}; xRange.forEach(x=>{idxSums[x]=0;idxCnts[x]=0});
                selectedStations.forEach(st => {
                    const openYear = stationOpenYears[st] || 2021;
                    const openQ = `${openYear}Q1`;
                    const stRows = baseData.filter(d=>d.name===st);
                    const qVal={}; stRows.forEach(r=>qVal[r.quarter]=(qVal[r.quarter]||0)+r.population);
                    const baseVal = qVal[openQ];
                    const fullQList = Object.keys(qVal).sort();
                    const openIdx = fullQList.indexOf(openQ);
                    if(baseVal && openIdx!==-1) {
                        fullQList.forEach((q,i)=>{
                            const diff=i-openIdx; if(diff>=-8 && diff<=8){
                                idxSums[diff]+=(qVal[q]/baseVal)*100; idxCnts[diff]++;
                            }
                        });
                    }
                });
                const yAvg = xRange.map(x=>idxCnts[x]>0?idxSums[x]/idxCnts[x]:null);
                relTraces.push({x:xRange, y:yAvg, mode:'lines+markers', name:'평균 성장률', line:{color:'#d97706', width:3}});
                Plotly.newPlot('chart3-relative', relTraces, { margin:{t:20,b:40,l:40,r:20}, yaxis:{title:'Index'}, shapes:[{type:'line',x0:0,x1:0,y0:0,y1:1,xref:'x',yref:'paper',line:{color:'red',dash:'dot'}}] }, {responsive:true});

            } else {
                // Bar Mode (Add Percentage)
                const groupSums = { 1:{}, 2:{}, 3:{}, 4:{} };
                xRange.forEach(x => { for(let k=1;k<=4;k++) groupSums[k][x]=0; });

                let detailData = rawData.filter(d => selectedStations.includes(d.name) && (d.item.includes('세')||d.item.includes('0~')));
                if(dist !== 'all') detailData = detailData.filter(d => d.distance === dist);

                selectedStations.forEach(st => {
                    const openYear = stationOpenYears[st] || 2021;
                    const openQ = `${openYear}Q1`;
                    const fullQList = [...new Set(rawData.map(d=>d.quarter))].sort();
                    const openIdx = fullQList.indexOf(openQ);
                    if(openIdx === -1) return;
                    const stRows = detailData.filter(d => d.name === st);
                    stRows.forEach(r => {
                        const currIdx = fullQList.indexOf(r.quarter);
                        const diff = currIdx - openIdx;
                        if(diff >= -8 && diff <= 8) groupSums[getAgeGroup(r.item).order][diff] += r.population;
                    });
                });

                [1,2,3,4].forEach(o => {
                     const gInfo = [null, getAgeGroup('0세'), getAgeGroup('20세'), getAgeGroup('40세'), getAgeGroup('60세')][o];
                     const yVals = xRange.map(x=>groupSums[o][x]);
                     const tVals = xRange.map(x => {
                         const total = groupSums[1][x] + groupSums[2][x] + groupSums[3][x] + groupSums[4][x];
                         return total > 0 ? ((groupSums[o][x]/total)*100).toFixed(1)+'%' : '';
                     });

                     relTraces.push({ 
                         x: xRange, y: yVals, name:gInfo.name, type:'bar', marker:{color:gInfo.color},
                         text: tVals, textposition: 'inside', textfont: {size:10}
                     });
                });
                Plotly.newPlot('chart3-relative', relTraces, { barmode:'stack', margin:{t:20,b:40,l:40,r:20}, xaxis:{title:'경과 분기', dtick:1} }, {responsive:true});
            }
        }

        // -----------------------------------------------------------------
        // Chart 4: 증감
        // -----------------------------------------------------------------
        function updateChart4() {
            const selectedStations = getSelectedStations();
            if (selectedStations.length===0) return;
            const dist = document.getElementById('global-distance').value;
            const win = document.getElementById('chart4-window').value;
            const mode = document.querySelector('input[name="chart4-mode"]:checked').value;
            const offsetMap = {'6m':2, '1y':4, '2y':8, '3y':12};
            const offset = offsetMap[win];
            const fullQList = [...new Set(rawData.map(d=>d.quarter))].sort();
            const preSums = {1:0, 2:0, 3:0, 4:0};
            const postSums = {1:0, 2:0, 3:0, 4:0};
            let detailData = rawData.filter(d => selectedStations.includes(d.name) && (d.item.includes('세')||d.item.includes('0~')));
            if(dist !== 'all') detailData = detailData.filter(d => d.distance === dist);
            selectedStations.forEach(st => {
                const openYear = stationOpenYears[st] || 2021;
                const openIdx = fullQList.indexOf(`${openYear}Q1`);
                if(openIdx === -1) return;
                const preIdx = openIdx - offset;
                const postIdx = openIdx + offset;
                if(preIdx<0 || postIdx>=fullQList.length) return;
                const stRows = detailData.filter(d => d.name === st);
                stRows.forEach(r => {
                    const g = getAgeGroup(r.item).order;
                    if(r.quarter === fullQList[preIdx]) preSums[g] += r.population;
                    if(r.quarter === fullQList[postIdx]) postSums[g] += r.population;
                });
            });
            const xVal = [], yVal = [], cVal = [], tVal = [];
            [1,2,3,4].forEach(o => {
                const info = [null, getAgeGroup('0세'), getAgeGroup('20세'), getAgeGroup('40세'), getAgeGroup('60세')][o];
                xVal.push(info.name);
                const pre = preSums[o]; const post = postSums[o];
                let val = 0; let txt = '';
                if (mode === 'pct') {
                    if (pre > 0) { val = ((post - pre) / pre) * 100; txt = val.toFixed(1) + '%'; } else { val = 0; txt = '-'; }
                } else {
                    val = post - pre; txt = (val>0?'+':'') + Math.round(val).toLocaleString();
                }
                yVal.push(val); cVal.push(info.color); tVal.push(txt);
            });
            Plotly.newPlot('chart4', [{ x: xVal, y: yVal, type: 'bar', marker:{color:cVal}, text: tVal, textposition: 'auto' }], { margin: {t:30, b:30}, yaxis: { title: mode==='pct'?'증감률 (%)':'증감수 (명)' }, shapes: [{type:'line', x0:-0.5, x1:3.5, y0:0, y1:0, line:{color:'black', width:1}}] }, {responsive:true});
        }
    </script>
</body>
</html>